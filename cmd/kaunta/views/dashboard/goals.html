{{define "page-subtitle"}}Goals Management{{end}} {{define "navigation"}}
<a
  href="/dashboard"
  class="btn btn-sm btn-ghost glass transition-standard"
  title="Back to Dashboard"
>
  <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M10 19l-7-7m0 0l7-7m-7 7h18"
    ></path>
  </svg>
  Dashboard
</a>
{{end}} {{define "website-selector"}}
<div id="goals-website-selector" data-show="$websites.length > 0">
  <!-- Website selector populated via SSE -->
</div>
{{end}} {{define "date-controls"}}
<!-- Goals page doesn't need date controls -->
{{end}} {{define "filters"}}
<!-- Goals page doesn't need filters -->
{{end}} {{define "header-buttons"}}
<button
  data-show="$selectedWebsite"
  data-on:click="$showCreateModal = true"
  title="Add Goal"
  class="btn btn-sm btn-primary glass transition-standard"
>
  <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
  </svg>
  Add Goal
</button>
{{end}} {{define "page-scripts"}}
<script src="/assets/js/goals.js?v={{.Version}}"></script>
{{end}} {{define "content"}}
<!-- Goals Dashboard (Datastar) -->
<div
  id="goals-dashboard"
  data-signals="{
       goalsLoading: true,
       goalsError: '',
       goals: [],
       websites: [],
       selectedWebsite: localStorage.getItem('kaunta_website') || '',
       lastGoalsWebsite: '',
       currentWebsiteName: '',
       showCreateModal: false,
       showEditModal: false,
       showAnalyticsModal: false,
       submitting: false,
       formError: '',
       currentGoal: null,
       goalForm: { name: '', type: '', value: '' },
       toast: { show: false, message: '', type: '' },
       analyticsLoading: false,
       analyticsDateRange: '7',
       analyticsTab: 'pages',
       analytics: { completions: 0, unique_sessions: 0, conversion_rate: 0, total_sessions: 0 },
       breakdownData: [],
       breakdownLoading: false,
       goalsReload: false,
       lastAnalyticsRequestKey: '',
       lastBreakdownRequestKey: ''
     }"
  data-init="@get('/api/dashboard/goals')"
>
  <!-- Loading State -->
  <div data-show="$goalsLoading" class="loading" style="margin-top: 100px">
    <div class="spinner"></div>
    <div>Loading goals...</div>
  </div>

  <div
    aria-hidden="true"
    style="display: none"
    data-effect="
      if ($showAnalyticsModal && $currentGoal && $currentGoal.id) {
        const key = [$currentGoal.id, $analyticsDateRange].join('::');
        if ($lastAnalyticsRequestKey !== key) {
          $lastAnalyticsRequestKey = key;
          $analyticsLoading = true;
          const encodedId = encodeURIComponent($currentGoal.id);
          @get('/api/dashboard/goals/' + encodedId + '/analytics?days=' + $analyticsDateRange);
        }
      } else if ($lastAnalyticsRequestKey) {
        $lastAnalyticsRequestKey = '';
        $analyticsLoading = false;
      }
    "
  ></div>

  <div
    aria-hidden="true"
    style="display: none"
    data-effect="
      if ($showAnalyticsModal && $currentGoal && $currentGoal.id) {
        const key = [$currentGoal.id, $analyticsDateRange, $analyticsTab].join('::');
        if ($lastBreakdownRequestKey !== key) {
          $lastBreakdownRequestKey = key;
          $breakdownLoading = true;
          const encodedId = encodeURIComponent($currentGoal.id);
          @get('/api/dashboard/goals/' + encodedId + '/breakdown/' + $analyticsTab + '?days=' + $analyticsDateRange);
        }
      } else if ($lastBreakdownRequestKey) {
        $lastBreakdownRequestKey = '';
        $breakdownLoading = false;
      }
    "
  ></div>

  <!-- Goals Table -->
  <div
    class="section glass card"
    data-attr:hidden="$goalsLoading || $goalsError || !$selectedWebsite"
  >
    <div class="section-header">
      <h2>
        <svg
          class="icon-lg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <circle cx="12" cy="12" r="8"></circle>
          <circle cx="12" cy="12" r="5"></circle>
          <circle cx="12" cy="12" r="2"></circle>
          <path d="M18 6l-6.5 6.5" />
          <path d="M13.5 6.5L18 6l-1 5.5" />
        </svg>
        <span id="website-name-display" data-text="$currentWebsiteName || ''"></span> Goals
      </h2>
    </div>

    <!-- Goals table container - populated via SSE PatchElements -->
    <div id="goals-table-container" data-element="goals-table-container">
      <!-- Table content will be patched via SSE -->
      <div class="empty-state">
        <div class="empty-state-icon">‚ãØ</div>
        <div class="empty-state-title">Loading goals...</div>
      </div>
    </div>
  </div>

  <!-- No Website Selected -->
  <div
    data-show="!$goalsLoading && !$goalsError && !$selectedWebsite"
    class="empty-state"
    style="margin-top: 100px"
  >
    <div class="empty-state-icon">üåê</div>
    <div class="empty-state-title">Select a Website</div>
    <div class="empty-state-text">Choose a website from the dropdown above to manage goals</div>
  </div>

  <!-- Error State -->
  <div data-show="!$goalsLoading && $goalsError" class="empty-state" style="margin-top: 100px">
    <div class="empty-state-icon">‚ö†Ô∏è</div>
    <div class="empty-state-title">Unable to load goals</div>
    <div class="empty-state-text" data-text="$goalsError"></div>
    <button
      data-on:click="@get('/api/dashboard/goals')"
      class="btn btn-primary"
      style="margin-top: 16px"
    >
      Try Again
    </button>
  </div>

  <!-- Create/Edit Goal Modal -->
  <div
    data-show="$showCreateModal || $showEditModal"
    class="modal-overlay"
    style="display: none"
    data-on:click="
      if (evt.target === el) {
        $showCreateModal = false;
        $showEditModal = false;
        $currentGoal = null;
        $goalForm = { name: '', type: '', value: '' };
        $formError = '';
        $analyticsLoading = false;
        $lastAnalyticsRequestKey = '';
      }
    "
  >
    <div class="modal glass card" data-on:click="evt.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">
          <svg class="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
            ></path>
          </svg>
          <span data-show="$showEditModal">Edit Goal</span>
          <span data-show="$showCreateModal">Add New Goal</span>
        </h2>
        <button
          type="button"
          class="modal-close"
          data-on:click="$showCreateModal = false; $showEditModal = false; $currentGoal = null; $goalForm = { name: '', type: '', value: '' }; $formError = ''"
          aria-label="Close modal"
        >
          <svg class="icon-md" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>
      <form
        data-on:submit__prevent="
          if ($submitting) {
            return;
          }
          $submitting = true;
          $showEditModal
            ? @put('/api/dashboard/goals/' + $currentGoal.id, { contentType: 'form', headers: { 'X-CSRF-Token': getGoalsCsrfToken() } })
            : @post('/api/dashboard/goals', { contentType: 'form', headers: { 'X-CSRF-Token': getGoalsCsrfToken() } });
        "
      >
        <input type="hidden" name="website_id" data-attr:value="$selectedWebsite" />
        <div class="form-group">
          <label for="goal-name">Goal Name *</label>
          <input
            type="text"
            id="goal-name"
            name="name"
            data-bind:goalForm.name
            required
            class="input"
            placeholder="e.g., Newsletter Signup"
          />
        </div>
        <div class="form-group">
          <label for="goal-type">Goal Type *</label>
          <select id="goal-type" name="type" data-bind:goalForm.type required class="input">
            <option value="">Select type...</option>
            <option value="page_view">Page View</option>
            <option value="custom_event">Custom Event</option>
          </select>
        </div>
        <div class="form-group">
          <label for="goal-value">
            <span data-show="$goalForm.type === 'page_view'">Page URL *</span>
            <span data-show="$goalForm.type === 'custom_event'">Event Name *</span>
            <span data-show="!$goalForm.type">Value *</span>
          </label>
          <input
            type="text"
            id="goal-value"
            name="value"
            data-bind:goalForm.value
            required
            class="input"
            data-attr:placeholder="$goalForm.type === 'page_view' ? '/thank-you' : ($goalForm.type === 'custom_event' ? 'signup_completed' : 'Enter value...')"
          />
          <small data-show="$goalForm.type === 'page_view'"
            >Enter the URL path (e.g., /thank-you or /success)</small
          >
          <small data-show="$goalForm.type === 'custom_event'"
            >Enter the custom event name you'll track</small
          >
        </div>
        <div data-show="$formError" class="error-message" data-text="$formError"></div>
        <div class="modal-actions">
          <button
            type="button"
            data-on:click="$showCreateModal = false; $showEditModal = false; $currentGoal = null; $goalForm = { name: '', type: '', value: '' }; $formError = ''"
            class="btn btn-ghost"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" data-attr:disabled="$submitting">
            <span data-show="!$submitting && $showEditModal">Update Goal</span>
            <span data-show="!$submitting && $showCreateModal">Create Goal</span>
            <span data-show="$submitting">Saving...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Analytics Modal -->
  <div
    data-show="$showAnalyticsModal"
    class="modal-overlay"
    style="display: none"
    data-on:click="
      if (evt.target === el) {
        $showAnalyticsModal = false;
        $currentGoal = null;
        destroyGoalChart();
        $breakdownData = [];
        $analyticsLoading = false;
        $lastAnalyticsRequestKey = '';
      }
    "
  >
    <div class="modal modal-lg glass card" data-on:click="evt.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">
          <svg class="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
            ></path>
          </svg>
          <span
            >Analytics: <span id="analytics-goal-name"><!-- SSE populated --></span></span
          >
        </h2>
        <button
          type="button"
          class="modal-close"
          data-on:click="$showAnalyticsModal = false; $currentGoal = null; destroyGoalChart(); $breakdownData = []; $analyticsLoading = false; $lastAnalyticsRequestKey = ''"
          aria-label="Close modal"
        >
          <svg class="icon-md" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Date Range Filter -->
      <div class="date-range-buttons glass" style="margin-bottom: 24px">
        <button
          class="btn btn-xs date-btn"
          data-class:active="$analyticsDateRange === '1'"
          data-on:click="$analyticsDateRange = '1'"
        >
          Today
        </button>
        <button
          class="btn btn-xs date-btn"
          data-class:active="$analyticsDateRange === '7'"
          data-on:click="$analyticsDateRange = '7'"
        >
          7 days
        </button>
        <button
          class="btn btn-xs date-btn"
          data-class:active="$analyticsDateRange === '30'"
          data-on:click="$analyticsDateRange = '30'"
        >
          30 days
        </button>
      </div>

      <!-- Conversion Metrics Cards - populated via SSE -->
      <div
        data-attr:hidden="$analyticsLoading"
        id="analytics-stats-container"
        data-element="analytics-stats-container"
        class="stats-grid"
        style="margin-bottom: 24px"
      >
        <div class="stat-card glass card">
          <div class="stat-label">Conversion Rate</div>
          <div class="stat-value">
            <span id="stat-conversion-rate">0%</span>
          </div>
          <div class="stat-footer">
            <span id="stat-sessions-summary">0 of 0 sessions</span>
          </div>
        </div>
        <div class="stat-card glass card">
          <div class="stat-label">Total Completions</div>
          <div class="stat-value" id="stat-completions">0</div>
        </div>
        <div class="stat-card glass card">
          <div class="stat-label">Unique Sessions</div>
          <div class="stat-value" id="stat-unique-sessions">0</div>
        </div>
        <div class="stat-card glass card">
          <div class="stat-label">Total Sessions</div>
          <div class="stat-value" id="stat-total-sessions">0</div>
        </div>
      </div>

      <!-- Time Series Chart -->
      <div
        data-attr:hidden="$analyticsLoading"
        class="section glass card"
        style="margin-bottom: 24px"
      >
        <h3 style="margin-bottom: 16px; font-size: var(--font-lg); color: var(--accent-dark)">
          Completions Over Time
        </h3>
        <canvas id="goalChart" style="max-height: 300px"></canvas>
      </div>

      <!-- Tabbed Breakdowns -->
      <div data-attr:hidden="$analyticsLoading" class="section glass card">
        <div class="tabs" role="tablist">
          <button
            class="tab transition-standard"
            data-class:active="$analyticsTab === 'pages'"
            data-on:click="$analyticsTab = 'pages'"
          >
            Top Converting Pages
          </button>
          <button
            class="tab transition-standard"
            data-class:active="$analyticsTab === 'referrer'"
            data-on:click="$analyticsTab = 'referrer'"
          >
            Referrers
          </button>
          <button
            class="tab transition-standard"
            data-class:active="$analyticsTab === 'country'"
            data-on:click="$analyticsTab = 'country'"
          >
            Countries
          </button>
          <button
            class="tab transition-standard"
            data-class:active="$analyticsTab === 'device'"
            data-on:click="$analyticsTab = 'device'"
          >
            Devices
          </button>
          <button
            class="tab transition-standard"
            data-class:active="$analyticsTab === 'browser'"
            data-on:click="$analyticsTab = 'browser'"
          >
            Browsers
          </button>
        </div>

        <!-- Breakdown Table - populated via SSE -->
        <div id="analytics-breakdown-container" data-element="analytics-breakdown-container">
          <!-- Table content will be patched via SSE -->
        </div>

        <div id="analytics-breakdown-empty" class="empty-state" style="display: none">
          <div class="empty-state-text">No data available for this breakdown</div>
        </div>
      </div>

      <!-- Loading State -->
      <div data-show="$analyticsLoading" class="loading" style="margin: 40px 0">
        <div class="spinner"></div>
        <div>Loading analytics...</div>
      </div>
    </div>
  </div>

  <!-- Auto-load goals when website changes -->
  <div
    aria-hidden="true"
    style="display: none"
    data-effect="
      if ($websites && $websites.length) {
        const site = $websites.find((w) => w.id === $selectedWebsite);
        $currentWebsiteName = site ? (site.name || site.domain) : '';
      }
      if ($selectedWebsite && $selectedWebsite !== $lastGoalsWebsite) {
        $lastGoalsWebsite = $selectedWebsite;
        $goalsLoading = true;
        @get('/api/dashboard/goals?website=' + encodeURIComponent($selectedWebsite));
      }
    "
  ></div>

  <div
    aria-hidden="true"
    style="display: none"
    data-effect="
      if ($goalsReload && $selectedWebsite) {
        @get('/api/dashboard/goals?website=' + encodeURIComponent($selectedWebsite));
        $goalsReload = false;
      }
    "
  ></div>

  <!-- Toast Notification -->
  <div
    data-show="$toast.show"
    class="toast"
    data-class:success="$toast.type === 'success'"
    data-class:error="$toast.type === 'error'"
    data-text="$toast.message"
  ></div>
</div>
{{end}}
