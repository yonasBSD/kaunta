{{define "page-subtitle"}}Visitor Map{{end}} {{define "navigation"}}
<a
  href="/dashboard"
  class="btn btn-sm btn-ghost glass transition-standard"
  title="Back to Dashboard"
>
  <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M10 19l-7-7m0 0l7-7m-7 7h18"
    ></path>
  </svg>
  Dashboard
</a>
{{end}} {{define "website-selector"}}
<div id="website-selector-container" data-show="$websites.length > 0">
  <!-- Selector populated via SSE -->
</div>
{{end}} {{define "header-buttons"}}
<!-- Map page doesn't need header buttons -->
{{end}} {{define "page-scripts"}}
<script src="/assets/js/map.js?v={{.Version}}"></script>
{{end}} {{define "content"}}

<!-- Map Dashboard (Datastar) -->
<div
  id="map-dashboard"
  data-signals:websitesLoading="true"
  data-signals:websitesError="false"
  data-signals:websites="[]"
  data-signals:selectedWebsite="localStorage.getItem('kaunta_website') || ''"
  data-signals:mapLoading="false"
  data-signals:mapError="''"
  data-signals:mapData="null"
  data-signals:mapTotalVisitors="0"
  data-signals:mapPeriodDays="7"
  data-signals:lastMapWebsite="''"
  data-init="@get('/api/dashboard/map-init')"
>

  <!-- Map Section -->
  <div data-show="!$websitesLoading && !$websitesError && $selectedWebsite && $websites.length > 0">
    <div class="section glass card">
      <div class="section-header">
        <h2>
          <svg class="icon-lg" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7.5l6.553-3.776A1 1 0 0117 5.618v10.764a1 1 0 01-1.447.894L9 16.5l-6.553 3.776z"
            ></path>
          </svg>
          Visitor Map
        </h2>
      </div>

      <!-- Loading indicator for map -->
      <div data-show="$mapLoading" class="loading">
        <div class="spinner"></div>
        <div>Loading map data...</div>
      </div>

      <!-- Map container -->
      <div
        style="
          height: 600px;
          border-radius: 8px;
          overflow: hidden;
          background: var(--bg-secondary);
          margin-top: 24px;
          position: relative;
        "
      >
        <div id="choropleth-map" style="width: 100%; height: 100%"></div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div data-show="$websitesLoading" class="loading" style="margin-top: 100px">
    <div class="spinner"></div>
    <div>Loading map...</div>
  </div>

  <!-- No Website Selected -->
  <div
    data-show="!$websitesLoading && !$websitesError && !$selectedWebsite && $websites.length > 0"
    class="empty-state"
    style="margin-top: 100px"
  >
    <div class="empty-state-icon">ğŸŒ</div>
    <div class="empty-state-title">Select a Website</div>
    <div class="empty-state-text">Choose a website from the dropdown above to view visitor map</div>
  </div>

  <!-- No Websites at All -->
  <div
    data-show="!$websitesLoading && !$websitesError && $websites.length === 0"
    class="empty-state"
    style="margin-top: 100px"
  >
    <div class="empty-state-icon">ğŸ›°ï¸</div>
    <div class="empty-state-title">No websites found</div>
    <div class="empty-state-text">Add a website in Kaunta to get started.</div>
  </div>

  <!-- Websites Load Error -->
  <div data-show="!$websitesLoading && $websitesError" class="empty-state" style="margin-top: 100px">
    <div class="empty-state-icon">âš ï¸</div>
    <div class="empty-state-title">Unable to load websites</div>
    <div class="empty-state-text" data-text="$websitesError || 'Check the server logs and try again.'"></div>
  </div>

  <!-- Map Error -->
  <div data-show="$mapError" class="empty-state" style="margin-top: 40px">
    <div class="empty-state-icon">ğŸ—ºï¸</div>
    <div class="empty-state-title">Map unavailable</div>
    <div class="empty-state-text" data-text="$mapError"></div>
  </div>

  <!-- Auto-load map data when website changes -->
  <div
    aria-hidden="true"
    style="display: none"
    data-effect="
      if ($selectedWebsite) {
        if ($selectedWebsite !== $lastMapWebsite) {
          $lastMapWebsite = $selectedWebsite;
          $mapLoading = true;
          @get('/api/dashboard/map?website_id=' + encodeURIComponent($selectedWebsite));
        }
      }
    "
  ></div>

  <!-- Re-render map when map data updates -->
  <div
    aria-hidden="true"
    style="display: none"
    data-effect="
      if ($mapData && window.initChoroplethMap) {
        const payload = Array.isArray($mapData) ? { data: $mapData } : $mapData;
        window.initChoroplethMap(payload);
      } else if (!$mapData && window.cleanupMap) {
        window.cleanupMap();
      }
    "
  ></div>
</div>

{{end}}
